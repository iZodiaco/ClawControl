/**
 * fix-ios-splash.js
 *
 * Ensures the iOS splash screen uses our custom image after `cap sync`.
 * Capacitor generates a default LaunchScreen.storyboard that references "Splash"
 * from Assets.xcassets, but the Splash.imageset may be missing Contents.json
 * or may not have been generated by @capacitor/assets.
 *
 * This script:
 * 1. Copies build/splash.png into the Splash.imageset at all 3 scales
 * 2. Creates a proper Contents.json so Xcode can find the images
 *
 * Run after `cap sync ios` and before `cap open ios`.
 */

const fs = require('fs');
const path = require('path');

const PROJECT_ROOT = path.join(__dirname, '..');
const SPLASH_SOURCE = path.join(PROJECT_ROOT, 'build', 'splash.png');
const SPLASH_IMAGESET = path.join(PROJECT_ROOT, 'ios', 'App', 'App', 'Assets.xcassets', 'Splash.imageset');

function fixIosSplash() {
  // Check if iOS project exists (only works on Mac after cap sync)
  if (!fs.existsSync(path.join(PROJECT_ROOT, 'ios', 'App'))) {
    console.log('⏭  iOS project not found, skipping splash fix');
    return;
  }

  // Check if source splash exists
  if (!fs.existsSync(SPLASH_SOURCE)) {
    console.error('✗  build/splash.png not found. Run generate-splash.js first.');
    process.exit(1);
  }

  // Ensure Splash.imageset directory exists
  fs.mkdirSync(SPLASH_IMAGESET, { recursive: true });

  // Copy splash image for all scale factors
  const scales = [
    'splash-2732x2732.png',
    'splash-2732x2732-1.png',
    'splash-2732x2732-2.png'
  ];

  for (const filename of scales) {
    const dest = path.join(SPLASH_IMAGESET, filename);
    fs.copyFileSync(SPLASH_SOURCE, dest);
  }

  // Write Contents.json
  const contentsJson = {
    images: [
      { filename: 'splash-2732x2732.png', idiom: 'universal', scale: '1x' },
      { filename: 'splash-2732x2732-1.png', idiom: 'universal', scale: '2x' },
      { filename: 'splash-2732x2732-2.png', idiom: 'universal', scale: '3x' }
    ],
    info: { author: 'xcode', version: 1 }
  };

  fs.writeFileSync(
    path.join(SPLASH_IMAGESET, 'Contents.json'),
    JSON.stringify(contentsJson, null, 2) + '\n'
  );

  console.log('✓  iOS splash screen images and Contents.json updated');

  // Check if LaunchScreen.storyboard exists and references Splash
  const storyboardPath = path.join(PROJECT_ROOT, 'ios', 'App', 'App', 'LaunchScreen.storyboard');
  if (fs.existsSync(storyboardPath)) {
    const content = fs.readFileSync(storyboardPath, 'utf8');
    if (content.includes('image="Splash"')) {
      console.log('✓  LaunchScreen.storyboard already references Splash image');
    } else {
      console.warn('⚠  LaunchScreen.storyboard does not reference "Splash" image.');
      console.warn('   The storyboard may need manual editing in Xcode to use the Splash image.');
    }
  } else {
    console.warn('⚠  LaunchScreen.storyboard not found — cap sync may not have completed fully');
  }
}

fixIosSplash();
